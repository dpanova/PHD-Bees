<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeeClassification &mdash; Bee Transformer  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Bee Transformer
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Bee Transformer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bee Transformer</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">BeeClassification</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for BeeClassification</h1><div class="highlight"><pre>
<span></span><span class="c1"># libraries</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="kn">from</span> <span class="nn">auxilary_functions</span> <span class="kn">import</span> <span class="n">get_file_names</span><span class="p">,</span> <span class="n">clean_directory</span><span class="p">,</span> <span class="n">compute_metrics</span><span class="p">,</span> <span class="n">preprocess_function</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span><span class="n">RandomizedSearchCV</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">librosa</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span>
<span class="kn">from</span> <span class="nn">audiomentations</span> <span class="kn">import</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">AddGaussianNoise</span><span class="p">,</span> <span class="n">TanhDistortion</span><span class="p">,</span> <span class="n">GainTransition</span><span class="p">,</span><span class="n">AirAbsorption</span>
<span class="kn">import</span> <span class="nn">soundfile</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Audio</span>
<span class="kn">import</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoFeatureExtractor</span><span class="p">,</span> <span class="n">AutoModelForAudioClassification</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>

<div class="viewcode-block" id="BeeClassification">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification">[docs]</a>
<span class="k">class</span> <span class="nc">BeeClassification</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;BeeNotBee class ....</span>
<span class="sd">    Class to conduct modelling based on labeled audio data, using HuggingFace transformers and Random Forest</span>
<span class="sd">    :param annotation_path: path to the annotation data which holds the labeled audio data</span>
<span class="sd">    :type annotation_path: str</span>
<span class="sd">    :param y_col: column label for the dependent variable in the annotation file, the label</span>
<span class="sd">    :type y_col: str</span>
<span class="sd">    :param x_col: column label for the independent variable in the annotation file. It is used to read the wav file.</span>
<span class="sd">    :type x_col: str</span>
<span class="sd">    :param acoustic_folder: folder name where acoustic files are stored</span>
<span class="sd">    :type acoustic_folder: str</span>
<span class="sd">    :bee_col: column which indicates the dependent variable in the annotation. In the beginning bothe bee_col and y_col are the same, but y_col can be updated during specific actions.</span>
<span class="sd">    :type bee_col: str</span>
<span class="sd">    :param acoustic_folder: folder name where the split files are stored</span>
<span class="sd">    :type acoustic_folder: str</span>
<span class="sd">    :param augment_folder: folder name where the augment files are stored</span>
<span class="sd">    :type augment_folder: str</span>
<span class="sd">    :param datadict_folder: folder name where the datadict files are stored</span>
<span class="sd">    :param logname: path to the log file</span>
<span class="sd">    :type logname: str</span>
<span class="sd">    :return: BeeClassification object</span>
<span class="sd">    :rtype: BeeClassification</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span>
                 <span class="p">,</span><span class="n">annotation_path</span> <span class="o">=</span><span class="s1">&#39;beeAnnotations_enhanced.csv&#39;</span>
                 <span class="p">,</span><span class="n">annotation_dtypes_path</span> <span class="o">=</span> <span class="s1">&#39;annotation_data_types.csv&#39;</span>
                 <span class="p">,</span><span class="n">x_col</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span>
                 <span class="p">,</span><span class="n">y_col</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span>
                 <span class="p">,</span><span class="n">bee_col</span> <span class="o">=</span> <span class="s1">&#39;label&#39;</span>
                 <span class="p">,</span><span class="n">logname</span><span class="o">=</span><span class="s1">&#39;bee.log&#39;</span>
                 <span class="p">,</span><span class="n">acoustic_folder</span> <span class="o">=</span> <span class="s1">&#39;data/SplitData/&#39;</span>
                 <span class="p">,</span><span class="n">augment_folder</span> <span class="o">=</span> <span class="s1">&#39;data/augment/&#39;</span>
                 <span class="p">,</span><span class="n">datadict_folder</span> <span class="o">=</span> <span class="s1">&#39;data/DataDict/&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forest_importances</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_path</span> <span class="o">=</span><span class="n">annotation_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation_dtypes_path</span> <span class="o">=</span> <span class="n">annotation_dtypes_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_col</span> <span class="o">=</span> <span class="n">x_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_col</span> <span class="o">=</span> <span class="n">y_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bee_col</span> <span class="o">=</span> <span class="n">bee_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acoustic_folder</span> <span class="o">=</span> <span class="n">acoustic_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accoustic_files</span> <span class="o">=</span> <span class="n">get_file_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acoustic_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">augment_folder</span> <span class="o">=</span> <span class="n">augment_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">augmented_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span> <span class="o">=</span> <span class="n">datadict_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadict_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">augmented_files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">logname</span>
                            <span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span>
                            <span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
                            <span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span>
                            <span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="c1">#validate the inputs</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">annotation_path</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid annotation_path type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">annotation_path</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> input is not the correct type. It should be .csv extension&#39;</span> <span class="o">%</span> <span class="n">annotation_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">annotation_dtypes_path</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid annotation_dtypes_path type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">annotation_dtypes_path</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation_dtypes_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> input is not the correct type. It should be .csv extension&#39;</span> <span class="o">%</span> <span class="n">annotation_dtypes_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">y_col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid y_col type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">y_col</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bee_col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid bee_col type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">bee_col</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">logname</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid logname type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">logname</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">acoustic_folder</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid acoustic_folder type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">acoustic_folder</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">augment_folder</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid augment_folder type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">augment_folder</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">datadict_folder</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid datadict_folder type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">datadict_folder</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="BeeClassification.read_annotation_csv">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.read_annotation_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">read_annotation_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read annotation data</span>
<span class="sd">        :return: pandas data frame with the annotations</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_path</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Annotation data is read successfully&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_annotation_csv</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Annotation data is NOT read successfully&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BeeClassification.new_y_label_creation">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.new_y_label_creation">[docs]</a>
    <span class="k">def</span> <span class="nf">new_y_label_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;missing queen&#39;</span><span class="p">,</span> <span class="s1">&#39;queen&#39;</span><span class="p">,</span>
       <span class="s1">&#39;active day&#39;</span><span class="p">,</span> <span class="s1">&#39;swarming&#39;</span><span class="p">],</span> <span class="n">new_col</span><span class="o">=</span><span class="s1">&#39;action&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform boolean columns into one column.</span>
<span class="sd">        :param old_col: list of column names</span>
<span class="sd">        :type old_col: list</span>
<span class="sd">        :param new_col: new column name</span>
<span class="sd">        :type new_col: str</span>
<span class="sd">        :return: updated annotation dataframe with a new column and updated y_col in the class</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">old_col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;old_col input is not the correct type. It is type </span><span class="si">%s</span><span class="s1">, but it should be a list.&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">old_col</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new_col input is not the correct type. It is type </span><span class="si">%s</span><span class="s1">, but it should be a str.&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">new_col</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_col</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> are not part of the annotation_df columns&#39;</span> <span class="o">%</span><span class="n">old_col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">[</span><span class="n">old_col</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_col</span> <span class="o">=</span> <span class="n">new_col</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New label created and assigned to the class&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="BeeClassification.validate_annotation_csv">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.validate_annotation_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">validate_annotation_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Validate annotation data</span>
<span class="sd">        :return: warning if the data is as expected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dtypes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_dtypes_path</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">dtypes_df</span><span class="p">[</span><span class="s1">&#39;col_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All columns are present correctly&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;NOT all columns are present correctly&quot;</span><span class="p">)</span>

        <span class="c1"># check that the data types are as expected</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
        <span class="n">data_type</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data_type</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dtypes_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">check_df</span> <span class="o">=</span> <span class="n">data_type</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dtypes_df</span><span class="p">,</span>
                                              <span class="n">right_on</span><span class="o">=</span><span class="n">dtypes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">left_on</span><span class="o">=</span><span class="n">dtypes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">check_df</span><span class="p">[</span><span class="s1">&#39;type check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_df</span><span class="p">[</span><span class="n">dtypes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_x&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">check_df</span><span class="p">[</span>
            <span class="n">dtypes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_y&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">check_df</span><span class="p">[</span><span class="s1">&#39;type check&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_df</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All data is in the correct type&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;NOT all data is in the correct type&quot;</span><span class="p">)</span></div>





<div class="viewcode-block" id="BeeClassification.split_annotation_data">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.split_annotation_data">[docs]</a>
    <span class="k">def</span> <span class="nf">split_annotation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">perc</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">stratified</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split the annotation data into train and test based on the y_col and x_col values. Save the csv files.</span>
<span class="sd">        :param perc: test split percentage, a number between 0.0 and 1.0</span>
<span class="sd">        :type perc: float</span>
<span class="sd">        :param stratified: Boolean value to indicate if the split should be stratified</span>
<span class="sd">        :type stratified: bool</span>
<span class="sd">        :return:annotation_df_updated with the final data which is split. X train, X test, y train and y test pandas data frames</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">perc</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;perc input is not the correct type. It is type </span><span class="si">%s</span><span class="s1">, but it should be a float.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">perc</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">perc</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;perc should be bigger than 0.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perc</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;perc should be smaller than 1.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">stratified</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;stratified input is not the correct type. It is type </span><span class="si">%s</span><span class="s1">, but it should be a boolean.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="n">stratified</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;x_col not in the annotation_df. Change x_col.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;y_col not in the annotation_df. Change y_col.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stratified</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_test_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_col</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_col</span><span class="p">]],</span>
                <span class="n">test_size</span><span class="o">=</span><span class="n">perc</span><span class="p">,</span>
                <span class="n">stratify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_col</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_test_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_col</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">annotation_df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_col</span><span class="p">]],</span>
                <span class="n">test_size</span><span class="o">=</span><span class="n">perc</span><span class="p">)</span>
        <span class="c1"># save all files for reproducibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;X_train_index.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test_index</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;X_test_index.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;y_train.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;y_test.csv&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="BeeClassification.file_read">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.file_read">[docs]</a>
    <span class="k">def</span> <span class="nf">file_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">output_file_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a wav file from the acoustic_folder where the name of the file has an index.</span>
<span class="sd">        :param file_index: index of the file we need to search for</span>
<span class="sd">        :type: int</span>
<span class="sd">        :param output_file_name: boolean indicating if file name should be outputed</span>
<span class="sd">        :type output_file_name: bool</span>
<span class="sd">        :return: file name, samples and sample rate arrays</span>
<span class="sd">        :rtype: string, numpy.ndarray and int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid file_index type. file_index is type </span><span class="si">%s</span><span class="s1"> and expected type is int.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accoustic_files</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;index&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.wav&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acoustic_folder</span> <span class="o">+</span> <span class="n">file_name</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> file exists.&#39;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mono</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_file_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>  <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> DOES NOT exist in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">file_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acoustic_folder</span><span class="p">))</span>
            <span class="c1"># raise ValueError(&#39;File %s DOES NOT exist in %s&#39; %(file_name, self.acoustic_folder))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">augmented_files</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;index&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.wav&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_folder</span> <span class="o">+</span> <span class="n">file_name</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> file exists.&#39;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mono</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output_file_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>  <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> DOES NOT exist in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">file_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acoustic_folder</span><span class="p">))</span></div>

            <span class="c1"># raise ValueError(&#39;File %s DOES NOT exist in %s&#39; % (file_name, self.augment_folder))</span>


<div class="viewcode-block" id="BeeClassification.dataframe_to_dataset_split_save">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.dataframe_to_dataset_split_save">[docs]</a>
    <span class="k">def</span> <span class="nf">dataframe_to_dataset_split_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span> <span class="n">split_type</span><span class="p">,</span><span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a pandas dataframe to data dict which is used in hugging face transformers. Then saves the data to the datadict_folder.</span>
<span class="sd">        :param df: pandas data frame which has to be converted</span>
<span class="sd">        :type df: pd.DataFrame</span>
<span class="sd">        :param split_type: &#39;train&#39; or &#39;test&#39; for training and testing sets</span>
<span class="sd">        :type split_type: str</span>
<span class="sd">        :param file_name: name of the file to be saved</span>
<span class="sd">        :type file_name: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split_type_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid df type. df is type </span><span class="si">%s</span><span class="s1"> and expected type is pd.core.frame.DataFrame.&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid file_name type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">split_type_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid split type. It should be from the list </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">split_type_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Column index is not part of df. It is a requirement. The index should provide the file index of the file to be read.&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
        <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({})</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_read</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span><span class="n">output_file_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">temp_dataset</span><span class="p">[</span><span class="s1">&#39;audio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span><span class="n">path</span><span class="p">,</span>
                                         <span class="s1">&#39;array&#39;</span><span class="p">:</span><span class="n">sample</span><span class="p">,</span>
                <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span><span class="n">sample_rate</span><span class="p">}]</span>

                <span class="c1"># to update here to have path as an array with everything below</span>
                <span class="n">temp_dataset</span><span class="p">[</span><span class="s1">&#39;train_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_index</span>
                <span class="n">temp_dataset</span><span class="p">[</span><span class="s1">&#39;file_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                    <span class="n">temp_dataset</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_col</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_dataset</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_col</span><span class="p">]</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataset</span><span class="p">,</span> <span class="n">temp_dataset</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split_type</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dataframe transformed to dataset.&#39;</span><span class="p">)</span>
        <span class="c1">#save the file with the first and the last index</span>
        <span class="c1">#Note: we use this function because it takes less than a sec to load the data, for .json functions, it took 3 min per chunk</span>

        <span class="k">if</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span><span class="o">+</span><span class="s2">&quot;/train/&quot;</span><span class="o">+</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span> <span class="o">+</span> <span class="s2">&quot;/test/&quot;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid split type. It should be from the list </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">split_type_list</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Save the data set.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BeeClassification.dataframe_to_dataset">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.dataframe_to_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">dataframe_to_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span> <span class="n">split_type</span><span class="p">,</span> <span class="n">num_chunks</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits a dataframe in specific number of chunks. Converts a pandas dataframe to data dict which is used in hugging face transformers. Then saves those chunks into files, reads them and returns the train data.</span>
<span class="sd">        :param df: pandas data frame which has to be converted</span>
<span class="sd">        :type df: pd.DataFrame</span>
<span class="sd">        :param split_type: &#39;train&#39; or &#39;test&#39; for training and testing sets</span>
<span class="sd">        :type split_type: str</span>
<span class="sd">        :param num_chunks: number of chunks to split the data</span>
<span class="sd">        :rtype num_chunks: int</span>
<span class="sd">        :return: Dataset</span>
<span class="sd">        :rtype: Dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split_type_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid df type. df is type </span><span class="si">%s</span><span class="s1"> and expected type is pd.core.frame.DataFrame.&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid num_chunks type. It is type </span><span class="si">%s</span><span class="s1"> and expected type is int.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">split_type_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid split type. It should be from the list </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">split_type_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Column index is not part of df. It is a requirement. The index should provide the file index of the file to be read.&#39;</span><span class="p">)</span>
        <span class="c1">#creating split folder</span>
        <span class="k">if</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="n">split_folder</span><span class="o">=</span><span class="s1">&#39;train/&#39;</span>
        <span class="k">elif</span> <span class="n">split_type</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="n">split_folder</span><span class="o">=</span><span class="s1">&#39;test/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid split type. It should be from the list </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">split_type_list</span><span class="p">)</span>
        <span class="c1">#clean the data in the folder</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clean_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span> <span class="o">+</span> <span class="n">split_folder</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># get all indices for the df</span>
        <span class="n">all_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">num_chunks</span><span class="p">)</span>
        <span class="c1">#intentionally we use for loop to reduce the memory usage</span>
        <span class="k">for</span> <span class="n">set_indices</span> <span class="ow">in</span> <span class="n">all_indices</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="c1"># save the file with the first and the last index</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;data</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">.hf&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">set_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="n">set_indices</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">set_indices</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_to_dataset_split_save</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">set_indices</span><span class="p">,],</span><span class="n">split_type</span><span class="o">=</span><span class="n">split_type</span><span class="p">,</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All Dataframes transformed to dataset and saved to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span><span class="p">)</span>

        <span class="c1"># concatinate all sub-data into one data and save it</span>
        <span class="c1"># get all file names</span>

        <span class="n">hf_files</span>  <span class="o">=</span> <span class="n">get_file_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span><span class="o">+</span><span class="n">split_folder</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_from_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span><span class="o">+</span><span class="n">split_folder</span><span class="o">+</span><span class="n">hf_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">hf_files</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">data_temp</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_from_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadict_folder</span><span class="o">+</span><span class="n">split_folder</span><span class="o">+</span><span class="n">f</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">concatenate_datasets</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_temp</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All data is loaded.&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">class_encode_column</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="BeeClassification.dataframe_to_datadict">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.dataframe_to_datadict">[docs]</a>
    <span class="k">def</span> <span class="nf">dataframe_to_datadict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts two data frames (test and train) into a data dict which will be used for HuggingFace transformers.</span>
<span class="sd">        :param train_df: data frame for the training set</span>
<span class="sd">        :type train_df: pd.DataFrame</span>
<span class="sd">        :param test_df: data frame for the testing set</span>
<span class="sd">        :type test_df: pd.DataFrame</span>
<span class="sd">        :return: datadict_data, stored in the object</span>
<span class="sd">        :rtype: datadict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.train_df_dataset = self.dataframe_to_dataset(train_df, split_type=&#39;train&#39;)</span>
        <span class="c1"># self.test_df_dataset = self.dataframe_to_dataset(test_df, split_type=&#39;test&#39;)</span>
        <span class="n">train_df_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_to_dataset</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="n">test_df_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_to_dataset</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">split_type</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">datadict_data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">DatasetDict</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_df_dataset</span><span class="p">,</span>
                <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test_df_dataset</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Data dictionary is created.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datadict_data</span></div>


<div class="viewcode-block" id="BeeClassification.data_augmentation_row">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.data_augmentation_row">[docs]</a>
    <span class="k">def</span> <span class="nf">data_augmentation_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A row-wise function which augments acoustic data and saves it in the acoustic_folder.</span>

<span class="sd">        :param arg: tuple with first argument the index of each row of a data frame, second argument - the actual row of the data frame</span>
<span class="sd">        :type arg: tuple</span>

<span class="sd">        :return: list of lists with the augmented data file index, the augmented data train index, the label of the augmented file and the original train index. If an issue occurs, only the original train and file indices are returned.</span>
<span class="sd">        :rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is list.&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">train_index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span><span class="n">n</span><span class="o">=</span> <span class="n">arg</span>

        <span class="c1"># get the necessary indices to trace files easily</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_col</span><span class="p">]</span>  <span class="c1"># this index is necessary to ensure we have the correct file name (coming from the annotation file)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_col</span><span class="p">]</span>
        <span class="c1"># check if the file from the annotation data exists in the folders</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># read the file</span>
            <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_read</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
            <span class="n">augment</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span>
                <span class="n">AddGaussianNoise</span><span class="p">(</span><span class="n">min_amplitude</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_amplitude</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">TanhDistortion</span><span class="p">(</span><span class="n">min_distortion</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">max_distortion</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">GainTransition</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">AirAbsorption</span><span class="p">(</span><span class="n">min_distance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">max_distance</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="p">])</span>
            <span class="n">augmented_samples</span> <span class="o">=</span> <span class="n">augment</span><span class="p">(</span><span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>
            <span class="n">augmented_file_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_index</span><span class="p">))</span>
            <span class="n">augmented_file_name</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">augmented_file_index</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.wav&#39;</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_folder</span> <span class="o">+</span> <span class="n">augmented_file_name</span><span class="p">,</span> <span class="n">augmented_samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">augmented_file_index</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">train_index</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>  <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;File with index </span><span class="si">%s</span><span class="s1"> is NOT augmented&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_index</span><span class="p">))</span></div>


<div class="viewcode-block" id="BeeClassification.data_augmentation_df">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.data_augmentation_df">[docs]</a>
    <span class="k">def</span> <span class="nf">data_augmentation_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function which augments the train data and saves it in the augmented folder (initially cleans the folder); replaces the train data by adding the augmented files information; stores the information in augmented_df; and saves the names of the augmented files in augmented_files.</span>
<span class="sd">        :param N: the number of times the augmentation process should happen</span>
<span class="sd">        :type N: int</span>
<span class="sd">        :return: the augmented data is saved</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid N type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is int.&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># clean augmented directory</span>
        <span class="n">clean_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_folder</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Augmented folder is cleaned.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">augmented_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># create the augmented files</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
            <span class="n">augmented</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_augmentation_row</span><span class="p">,</span>
                                     <span class="p">[(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()])</span>
            <span class="n">augmented_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">augmented</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;augmented_file_index&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;train_index&#39;</span><span class="p">])</span>
            <span class="n">augmented_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">augmented_df</span><span class="p">[</span><span class="s1">&#39;augmented_file_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">augmented_df</span><span class="p">[</span><span class="s1">&#39;augmented_file_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">augmented_df</span><span class="p">[</span><span class="s1">&#39;train_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">augmented_df</span><span class="p">[</span><span class="s1">&#39;train_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">augmented_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">augmented_df</span><span class="p">[</span><span class="s1">&#39;augmented_file_index&#39;</span><span class="p">]</span>
            <span class="c1"># augmented_df.dropna(inplace=True)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">augmented_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">augmented_df</span><span class="p">,</span><span class="n">augmented_df</span><span class="p">])</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Augmented data is created.&#39;</span><span class="p">)</span>
            <span class="c1"># split X</span>
            <span class="n">X_train_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">augmented_df</span><span class="p">[</span><span class="s1">&#39;augmented_file_index&#39;</span><span class="p">])</span>
            <span class="n">X_train_index</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span><span class="o">.</span><span class="n">columns</span>
            <span class="c1"># add the augmented data to the existing data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span><span class="p">])</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;X_train index is updated.&#39;</span><span class="p">)</span>
            <span class="c1"># split y</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">augmented_df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
            <span class="n">y_train</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># add the augmented data to the existing data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Y_train is updated.&#39;</span><span class="p">)</span>

        <span class="c1">#save the names of the augmented files for easy access later on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">augmented_files</span> <span class="o">=</span> <span class="n">get_file_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_folder</span><span class="p">)</span></div>



<div class="viewcode-block" id="BeeClassification.data_transformation_row">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.data_transformation_row">[docs]</a>
    <span class="k">def</span> <span class="nf">data_transformation_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A row-wise function which finds the correct file from the annotation data frame and then transforms the acoustic data with mfcc or mel spec. n_fft is set to 1000 due to the nature of the audio data.</span>
<span class="sd">        :param arg: tuple with first argument the index of each row of a data frame, second argument - the actual row of the data frame and third argument - data frame with the dependant variable</span>
<span class="sd">        :type arg: tuple</span>

<span class="sd">        :return: list of lists with the transformed data. The non-existent files are returned as None type.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is list.&#39;</span> <span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">train_index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">arg</span>

        <span class="c1"># get the necessary indices to trace files easily</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_col</span><span class="p">]</span>  <span class="c1"># this index is necessary to ensure we have the correct file name (coming from the annotation file)</span>
        <span class="c1"># check if the file from the annotation data exists in the folders</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># read the file</span>
            <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_read</span><span class="p">(</span><span class="n">file_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;mfcc&#39;</span><span class="p">:</span>
                <span class="n">sample_transformed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">librosa</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mfcc</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
                                                                  <span class="n">n_mfcc</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_fft</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">sample_transformed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">sample_transformed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">train_index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">librosa</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">melspectrogram</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">n_fft</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                                         <span class="n">hop_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">n_mels</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">sample_transformed</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">()</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File with index </span><span class="si">%s</span><span class="s1"> is transformed and added to the transformed data frame&#39;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">file_index</span><span class="p">))</span>

            <span class="c1"># return the transformed file and add the indices</span>
            <span class="k">return</span> <span class="n">sample_transformed</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">train_index</span><span class="p">,</span><span class="n">file_index</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;File with index </span><span class="si">%s</span><span class="s1"> is NOT added to the transformed data frame&#39;</span> <span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">file_index</span><span class="p">))</span></div>




<div class="viewcode-block" id="BeeClassification.data_transformation_df">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.data_transformation_df">[docs]</a>
    <span class="k">def</span> <span class="nf">data_transformation_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the correct file from the annotation data frame and then transform the acoustic data using mfcc or mel spec methods. Store the index from the annotation data frame (the key) and the df index to track the associated y values.</span>
<span class="sd">        :param X: pandas data frame with the indices of the acoustic files which need to be transformed</span>
<span class="sd">        :type X: pandas.DataFrame</span>
<span class="sd">        :param func: function for audio files transformation. One can choose from a list of options [&#39;mfcc&#39;,&#39;mel spec&#39;]</span>
<span class="sd">        :type func: function or method</span>

<span class="sd">        :return: data frame with the transformed data</span>
<span class="sd">        :rtype:pandas.dataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mfcc&#39;</span><span class="p">,</span><span class="s1">&#39;mel spec&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is pandas.core.frame.DataFrame.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Column index is not part of X data frame. It is a requirement.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">func_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid function. function should be from the list </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">func_list</span><span class="p">)</span>


        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="n">X_transformed</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_transformation_row</span><span class="p">,[(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()])</span>
        <span class="c1"># add the column names</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train_index&#39;</span><span class="p">,</span><span class="s1">&#39;file_index&#39;</span><span class="p">]</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X_transformed</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;col&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="c1"># transform to data frame</span>
        <span class="n">X_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X_transformed</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_length</span><span class="p">:</span>
                <span class="n">X_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X_df</span><span class="p">)]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_updated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="nb">list</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">max_length</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">X_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X_df</span><span class="p">)]</span> <span class="o">=</span> <span class="n">x_updated</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Whole data frame transformed.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_df</span></div>



<div class="viewcode-block" id="BeeClassification.transformer_classification">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.transformer_classification">[docs]</a>
    <span class="k">def</span> <span class="nf">transformer_classification</span><span class="p">(</span><span class="bp">self</span>
                                   <span class="p">,</span> <span class="n">data</span>
                                   <span class="p">,</span> <span class="n">max_duration</span><span class="o">=</span><span class="mi">5</span>
                                   <span class="p">,</span> <span class="n">model_id</span> <span class="o">=</span><span class="s1">&#39;facebook/hubert-base-ls960&#39;</span>
                                    <span class="p">,</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
                                    <span class="p">,</span><span class="n">gradient_accumulation_steps</span> <span class="o">=</span> <span class="mi">4</span>
                                    <span class="p">,</span><span class="n">num_train_epochs</span> <span class="o">=</span> <span class="mi">10</span>
                                   <span class="p">,</span><span class="n">warmup_ratio</span><span class="o">=</span><span class="mf">0.1</span>
                                   <span class="p">,</span><span class="n">logging_steps</span> <span class="o">=</span> <span class="mi">10</span>
                                   <span class="p">,</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">3e-5</span>
                                   <span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;finetuned-bee&#39;</span>
                                   <span class="p">,</span><span class="n">wandb</span><span class="o">=</span><span class="kc">True</span>
                                    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute huggingface transformer pre-trained classification model for audio data. It has been integrated with Weights &amp; Bises for further development and monitoring.</span>
<span class="sd">        :param data: DataDict for audio data with train and test</span>
<span class="sd">        :type data: DataDict</span>
<span class="sd">        :param max_duration: maximum duration of the data file</span>
<span class="sd">        :type max_duration: int</span>
<span class="sd">        :model_id: the name of the HiggingFace model</span>
<span class="sd">        :type model_id: str</span>
<span class="sd">        :param batch_size: The batch size per GPU/XPU/TPU/MPS/NPU core/CPU for training/testing.</span>
<span class="sd">        :type batch_size: int</span>
<span class="sd">        :param gradient_accumulation_steps: Number of updates steps to accumulate the gradients for, before performing a backward/update pass.</span>
<span class="sd">        :type gradient_accumulation_steps: int</span>
<span class="sd">        :param num_train_epochs:Total number of training epochs to perform (if not an integer, will perform the decimal part percents of the last epoch before stopping training).</span>
<span class="sd">        :type num_train_epochs: float</span>
<span class="sd">        :param warmup_ratio: Ratio of total training steps used for a linear warmup from 0 to learning_rate.</span>
<span class="sd">        :type warmup_ratio: float</span>
<span class="sd">        :param logging_steps:Number of update steps between two logs if logging_strategy=&quot;steps&quot;. Should be an integer or a float in range [0,1). If smaller than 1, will be interpreted as ratio of total training steps.</span>
<span class="sd">        :type logging_steps: float</span>
<span class="sd">        :param learning_rate:  The initial learning rate.</span>
<span class="sd">        :type learning_rate: float</span>
<span class="sd">        :param name: name of the newly created model</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param wandb: indicates if the is Weights &amp; Biases connected profile.</span>
<span class="sd">        :type wandb: bool</span>
<span class="sd">        :return: trained model</span>
<span class="sd">        :rtype: HuggingFace.models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#checks for the correct inputs</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">dataset_dict</span><span class="o">.</span><span class="n">DatasetDict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is datasets.dataset_dict.DatasetDict.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is str.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is int.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_duration</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is int.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_duration</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">gradient_accumulation_steps</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is int.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">gradient_accumulation_steps</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_train_epochs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is float.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_train_epochs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">warmup_ratio</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is float.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">warmup_ratio</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">logging_steps</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is float.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">logging_steps</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is float.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">wandb</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is bool.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">wandb</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wandb</span><span class="p">:</span>
            <span class="c1">#create WANDM environment</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># set the wandb project where this run will be logged</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_PROJECT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_name</span>

            <span class="c1"># save your trained model checkpoint to wandb</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_LOG_MODEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>

            <span class="c1"># turn off watch to log faster</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_WATCH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span>
        <span class="c1">#create the feature extractor</span>
        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">AutoFeatureExtractor</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">model_id</span><span class="p">,</span> <span class="n">do_normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_attention_mask</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="c1"># resample the data to have the same sampling rate as the pretrained model</span>
        <span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">sampling_rate</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cast_column</span><span class="p">(</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">Audio</span><span class="p">(</span><span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Data is transformed to the required sampling rate.&#39;</span><span class="p">)</span>

        <span class="c1">#create numeric labels</span>
        <span class="n">id2label_fn</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bee_col</span><span class="p">]</span><span class="o">.</span><span class="n">int2str</span>

        <span class="n">id2label_fn</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bee_col</span><span class="p">]</span><span class="o">.</span><span class="n">int2str</span>
        <span class="n">id2label</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">id2label_fn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bee_col</span><span class="p">]</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">label2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">id2label</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">id2label</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Labels are constructed&#39;</span><span class="p">)</span>

        <span class="c1">#construct the model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForAudioClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">model_id</span><span class="p">,</span>
            <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">,</span>
            <span class="n">label2id</span><span class="o">=</span><span class="n">label2id</span><span class="p">,</span>
            <span class="n">id2label</span><span class="o">=</span><span class="n">id2label</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Model is initiated.&#39;</span><span class="p">)</span>
        <span class="c1">#add the train arguments</span>

        <span class="k">if</span> <span class="n">wandb</span><span class="p">:</span>
            <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
                <span class="c1"># &quot;%s-%s&quot; %(model_name,name),</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;models&#39;</span><span class="p">,</span>
                <span class="n">report_to</span><span class="o">=</span><span class="s2">&quot;wandb&quot;</span><span class="p">,</span>
                <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="n">gradient_accumulation_steps</span><span class="p">,</span>
                <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">num_train_epochs</span><span class="o">=</span><span class="n">num_train_epochs</span><span class="p">,</span>
                <span class="n">warmup_ratio</span><span class="o">=</span><span class="n">warmup_ratio</span><span class="p">,</span>
                <span class="n">logging_steps</span><span class="o">=</span><span class="n">logging_steps</span><span class="p">,</span>
                <span class="n">fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">gradient_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span>
                <span class="n">push_to_hub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
                <span class="c1"># &quot;%s-%s&quot; %(model_name,name),</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;models&#39;</span><span class="p">,</span>
                <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">gradient_accumulation_steps</span><span class="o">=</span><span class="n">gradient_accumulation_steps</span><span class="p">,</span>
                <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                <span class="n">num_train_epochs</span><span class="o">=</span><span class="n">num_train_epochs</span><span class="p">,</span>
                <span class="n">warmup_ratio</span><span class="o">=</span><span class="n">warmup_ratio</span><span class="p">,</span>
                <span class="n">logging_steps</span><span class="o">=</span><span class="n">logging_steps</span><span class="p">,</span>
                <span class="n">fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">gradient_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span>
                <span class="n">push_to_hub</span><span class="o">=</span><span class="kc">False</span><span class="p">,)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Training arguments are set.&#39;</span><span class="p">)</span>
        <span class="c1">#encode the data</span>
        <span class="n">data_encoded</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">preprocess_function</span><span class="p">,</span>
            <span class="n">remove_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="s2">&quot;file_index&quot;</span><span class="p">],</span>
            <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">num_proc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">fn_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;feature_extractor&quot;</span><span class="p">:</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="s2">&quot;max_duration&quot;</span><span class="p">:</span> <span class="n">max_duration</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Data is encoded with the feature extractor.&#39;</span><span class="p">)</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">training_args</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">data_encoded</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
            <span class="n">eval_dataset</span><span class="o">=</span><span class="n">data_encoded</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">feature_extractor</span><span class="p">,</span>
            <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span>
        <span class="p">)</span>

        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Model is trained.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trainer</span></div>


<div class="viewcode-block" id="BeeClassification.best_model">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.best_model">[docs]</a>
    <span class="k">def</span> <span class="nf">best_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">param_dist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify the best model after tuning the hyperparameters</span>

<span class="sd">        :param model: an initiated machine learning model</span>
<span class="sd">        :type model: Any</span>
<span class="sd">        :param param_dist: a dictionary with the parameters and their respective ranges for the tuning</span>
<span class="sd">        :type param_dist: dict</span>
<span class="sd">        :return: RandomizedSearchCV object</span>
<span class="sd">        :rtype: RandomizedSearchCV</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_dist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is dict.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_dist</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">param_dist</span><span class="p">,</span>
                                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                            <span class="n">cv</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parameter tuning completed&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_model</span></div>


<div class="viewcode-block" id="BeeClassification.accuracy_metrics">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.accuracy_metrics">[docs]</a>
    <span class="k">def</span> <span class="nf">accuracy_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Provide accuracy metrics to compare the different models</span>

<span class="sd">        :param y_pred: predicted dependent values</span>
<span class="sd">        :type y_pred: list</span>
<span class="sd">        :return: accuracy, precision, recall</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is np.ndarray.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># accuracy score</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
            <span class="c1"># calculate the precision score</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Accuracy metrics calculated&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span></div>


<div class="viewcode-block" id="BeeClassification.misclassified_analysis">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.misclassified_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">misclassified_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Misclassification analysis to understand where the model miscalculates and if any pattern can be found</span>

<span class="sd">        :param y_pred: predicted dependent values</span>
<span class="sd">        :type y_pred: list</span>
<span class="sd">        :return: misclassified values</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is np.ndarray.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="c1"># check the misclassified datapoints</span>
            <span class="n">y_test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">)</span>
            <span class="n">y_test_df</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
            <span class="n">y_test_df</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">y_test_df</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span>
            <span class="n">misclassified</span> <span class="o">=</span> <span class="n">y_test_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y_test_df</span><span class="p">[</span><span class="o">~</span><span class="n">y_test_df</span><span class="p">[</span><span class="s1">&#39;check&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Misclassified analysis completed&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">misclassified</span></div>


<div class="viewcode-block" id="BeeClassification.model_results">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.model_results">[docs]</a>
    <span class="k">def</span> <span class="nf">model_results</span><span class="p">(</span><span class="bp">self</span>
                      <span class="p">,</span> <span class="n">model</span>
                      <span class="p">,</span> <span class="n">param_dist</span>
                      <span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="s1">&#39;mfcc&#39;</span>
                      <span class="p">,</span><span class="n">do_pca</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide a full picture of the model performance and accuracy</span>
<span class="sd">        :param model: an initiated machine learning model such as Random Forest</span>
<span class="sd">        :type model: Any</span>
<span class="sd">        :param param_dist: a dictionary with the parameters and their respective ranges for the tuning</span>
<span class="sd">        :type param_dist: dict</span>
<span class="sd">        :param func:function to transform the input variables. Possible values are &#39;mfcc&#39; and &#39;mel spec&#39;</span>
<span class="sd">        :type func: str</span>
<span class="sd">        :param do_pca: whether to run pca on the data and take the first two dimensions</span>
<span class="sd">        :type do_pca: bool</span>
<span class="sd">        :return: the best model with its accuracy metrics, misclassified analysis and pca explained variance (do_pca = True)</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_dist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is dict.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_dist</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">do_pca</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is dict.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">do_pca</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mfcc&#39;</span><span class="p">,</span> <span class="s1">&#39;mel spec&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is expected to be either mfcc or mel spec but it is&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use random search to find the best hyperparameters</span>
            <span class="n">rand_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">param_dist</span><span class="o">=</span><span class="n">param_dist</span><span class="p">)</span>

            <span class="c1"># transform the X_train and then get only the correct entries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_transformation_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_train_index</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_transformation_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_test_index</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">)</span>

            <span class="c1"># standardise the values</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train_index&#39;</span><span class="p">,</span> <span class="s1">&#39;file_index&#39;</span><span class="p">]]]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train_index&#39;</span><span class="p">,</span> <span class="s1">&#39;file_index&#39;</span><span class="p">]]]</span>
            <span class="n">x_test</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">do_pca</span><span class="p">:</span>

                <span class="c1">#conduct PCA to reduce overfitting</span>

                <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">principalComponents</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">pca_variance</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
                <span class="n">principalDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">principalComponents</span>
                                           <span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;principal component 1&#39;</span><span class="p">,</span> <span class="s1">&#39;principal component 2&#39;</span><span class="p">])</span>
                <span class="n">principalComponents_test</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
                <span class="n">principalDf_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">principalComponents_test</span>
                                                <span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;principal component 1&#39;</span><span class="p">,</span> <span class="s1">&#39;principal component 2&#39;</span><span class="p">])</span>

                <span class="c1"># fit the best model</span>
                <span class="n">rand_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">principalDf</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

                <span class="c1"># generate predictions with the best model</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">rand_search</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">principalDf_test</span><span class="p">)</span>

                <span class="c1"># calculate model accuracy</span>
                <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_metrics</span><span class="p">(</span><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">)</span>

                <span class="c1"># check the misclassified datapoints</span>
                <span class="n">misclassified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misclassified_analysis</span><span class="p">(</span><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">)</span>


                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Model Results Calculated&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">rand_search</span><span class="p">,</span> <span class="n">misclassified</span><span class="p">,</span> <span class="n">pca_variance</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># fit the best model</span>
                <span class="n">rand_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

                <span class="c1"># generate predictions with the best model</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">rand_search</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>

                <span class="c1"># calculate model accuracy</span>
                <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy_metrics</span><span class="p">(</span><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">)</span>

                <span class="c1"># check the misclassified datapoints</span>
                <span class="n">misclassified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misclassified_analysis</span><span class="p">(</span><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">)</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Model Results Calculated&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">rand_search</span><span class="p">,</span> <span class="n">misclassified</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>





<div class="viewcode-block" id="BeeClassification.random_forest_results">
<a class="viewcode-back" href="../BeeClassification.html#BeeClassification.BeeClassification.random_forest_results">[docs]</a>
    <span class="k">def</span> <span class="nf">random_forest_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s1">&#39;mfcc&#39;</span><span class="p">,</span> <span class="n">do_pca</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run Random Forest and conduct hyperparameter tuning, accuracy measurement and feature importance</span>
<span class="sd">        :param func:function to transform the input variables. Possible values are &#39;mfcc&#39; and &#39;mel spec&#39;</span>
<span class="sd">        :type func: str</span>
<span class="sd">        :param do_pca: whether to run pca on the data and take the first two dimensions</span>
<span class="sd">        :type do_pca: bool</span>
<span class="sd">        :return: accuracy, precision, recall, misclassified analysis, pca variance (do_pca=True) and feature importance</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mfcc&#39;</span><span class="p">,</span> <span class="s1">&#39;mel spec&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is expected to be either mfcc or mel spec but it is&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">do_pca</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid arg type. arg is type </span><span class="si">%s</span><span class="s1"> and expected type is dict.&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">do_pca</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">param_dist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span>
                          <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">]}</span>
            <span class="c1"># Create a random forest classifier</span>
            <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>

            <span class="c1"># check the model results</span>
            <span class="k">if</span> <span class="n">do_pca</span><span class="p">:</span>
                <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span>  <span class="n">rand_search</span><span class="p">,</span><span class="n">misclassified</span><span class="p">,</span> <span class="n">pca_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_results</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">rf</span>
                                                                                                      <span class="p">,</span> <span class="n">param_dist</span><span class="o">=</span><span class="n">param_dist</span>
                                                                                                      <span class="p">,</span><span class="n">do_pca</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">rand_search</span><span class="p">,</span> <span class="n">misclassified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_results</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">rf</span> <span class="p">,</span><span class="n">param_dist</span><span class="o">=</span><span class="n">param_dist</span>
                                                                                                      <span class="p">,</span><span class="n">do_pca</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Accuracy metrics are calculated.&#39;</span><span class="p">)</span>
            <span class="c1"># # check the features importance</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">rand_search</span><span class="o">.</span><span class="n">best_estimator_</span>

            <span class="n">importances</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">feature_importances_</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importance is calculated.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_pca</span><span class="p">:</span>

                <span class="n">forest_importances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;principal component 1&#39;</span><span class="p">,</span> <span class="s1">&#39;principal component 2&#39;</span><span class="p">])</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importance is calculated.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span> <span class="p">,</span> <span class="n">misclassified</span><span class="p">,</span> <span class="n">pca_variance</span><span class="p">,</span> <span class="n">forest_importances</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">forest_importances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                                                                   <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;train_index&#39;</span><span class="p">,</span> <span class="s1">&#39;file_index&#39;</span><span class="p">]])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importance is calculated.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">misclassified</span><span class="p">,</span> <span class="n">forest_importances</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Denitsa Panova.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>